const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = 3003;

// Middleware
app.use(cors({
  origin: [
    'http://localhost:3001', // Client
    'http://localhost:3002', // Admin
    'http://localhost:3000', // Fallback
    'http://127.0.0.1:3001', // Client IP
    'http://127.0.0.1:3002', // Admin IP
    'http://127.0.0.1:3000'  // Fallback IP
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
app.use(express.json());

// Data storage
const dataDir = path.join(__dirname, 'data');
const dishesFile = path.join(dataDir, 'dishes.json');
const categoriesFile = path.join(dataDir, 'categories.json');

// Ensure data directory exists
if (!fs.existsSync(dataDir)) {
  fs.mkdirSync(dataDir, { recursive: true });
}

// Initial data
const initialDishes = [
  {
    _id: '6',
    name: { fr: 'French Tacos Signature', en: 'Signature French Tacos', th: '‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ó‡∏≤‡πÇ‡∏Ñ‡πà‡∏ã‡∏¥‡∏Å‡πÄ‡∏ô‡πÄ‡∏à‡∏≠‡∏£‡πå', ru: '–§–∏—Ä–º–µ–Ω–Ω—ã–π —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π —Ç–∞–∫–æ—Å', de: 'Signature French Tacos' },
    description: { fr: 'Notre French Tacos signature avec poulet, frites, sauce fromag√®re', en: 'Our signature French Tacos with chicken, fries, cheese sauce', th: '‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ó‡∏≤‡πÇ‡∏Ñ‡πà‡∏ã‡∏¥‡∏Å‡πÄ‡∏ô‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏Å‡∏±‡∏ö‡πÑ‡∏Å‡πà ‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ü‡∏£‡∏≤‡∏¢ ‡∏ã‡∏≠‡∏™‡∏ä‡∏µ‡∏™', ru: '–ù–∞—à —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π —Ç–∞–∫–æ—Å —Å –∫—É—Ä–∏—Ü–µ–π, –∫–∞—Ä—Ç–æ—Ñ–µ–ª–µ–º —Ñ—Ä–∏ –∏ —Å—ã—Ä–Ω—ã–º —Å–æ—É—Å–æ–º', de: 'Unser Signature French Tacos mit H√§hnchen, Pommes, K√§sesauce' },
    category: '3',
    price: { amount: 280, currency: 'THB' },
    images: [],
    tags: { isNew: true, isPopular: false, isChefSpecial: true },
    dietary: { isVegetarian: false, isVegan: false, isSpicy: false, spicyLevel: 0 },
    isActive: true,
    preparationTime: 15,
    order: 1
  },
  {
    _id: '7',
    name: { fr: 'French Tacos Personnalisable', en: 'Customizable French Tacos', th: '‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ó‡∏≤‡πÇ‡∏Ñ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏î‡πâ', ru: '–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π —Ç–∞–∫–æ—Å', de: 'Anpassbare French Tacos' },
    description: { fr: 'Cr√©ez votre French Tacos sur mesure en choisissant vos ingr√©dients pr√©f√©r√©s', en: 'Create your custom French Tacos by choosing your favorite ingredients', th: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ü‡∏£‡∏ô‡∏ä‡πå‡∏ó‡∏≤‡πÇ‡∏Ñ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö', ru: '–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π —Ç–∞–∫–æ—Å, –≤—ã–±—Ä–∞–≤ –ª—é–±–∏–º—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', de: 'Erstellen Sie Ihren French Tacos nach Wunsch mit Ihren Lieblingszutaten' },
    category: '3',
    price: { amount: 220, currency: 'THB' },
    images: [],
    tags: { isNew: true, isPopular: true, isChefSpecial: false },
    dietary: { isVegetarian: false, isVegan: false, isSpicy: false, spicyLevel: 0 },
    isActive: true,
    preparationTime: 12,
    order: 2
  },
  {
    _id: '8',
    name: { fr: 'Burger Classique', en: 'Classic Burger', th: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ', ru: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –±—É—Ä–≥–µ—Ä', de: 'Klassischer Burger' },
    description: { fr: 'Burger beef avec salade, tomate, cornichons et sauce', en: 'Beef burger with lettuce, tomato, pickles and sauce', th: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏® ‡∏´‡∏±‡∏ß‡πÑ‡∏ä‡πÄ‡∏ó‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ã‡∏≠‡∏™', ru: '–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä —Å —Å–∞–ª–∞—Ç–æ–º, –ø–æ–º–∏–¥–æ—Ä–æ–º, —Å–æ–ª–µ–Ω—ã–º–∏ –æ–≥—É—Ä—Ü–∞–º–∏ –∏ —Å–æ—É—Å–æ–º', de: 'Rindfleisch-Burger mit Salat, Tomate, Gurken und Sauce' },
    category: '3',
    price: { amount: 250, currency: 'THB' },
    images: [],
    tags: { isNew: false, isPopular: true, isChefSpecial: false },
    dietary: { isVegetarian: false, isVegan: false, isSpicy: false, spicyLevel: 0 },
    isActive: true,
    preparationTime: 18,
    order: 3
  }
];

const initialCategories = [
  {
    _id: '1',
    name: { fr: 'Entr√©es', en: 'Appetizers', th: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏¢‡πà‡∏≠‡∏¢', ru: '–ó–∞–∫—É—Å–∫–∏', de: 'Vorspeisen' },
    description: { fr: 'D√©licieuses entr√©es pour commencer', en: 'Delicious starters', th: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏£‡πà‡∏≠‡∏¢', ru: '–í–∫—É—Å–Ω—ã–µ –∑–∞–∫—É—Å–∫–∏', de: 'K√∂stliche Vorspeisen' },
    icon: 'ü•ó',
    order: 1,
    isActive: true,
    dishCount: 8
  },
  {
    _id: '2',
    name: { fr: 'Soupes', en: 'Soups', th: '‡∏ã‡∏∏‡∏õ', ru: '–°—É–ø—ã', de: 'Suppen' },
    description: { fr: 'Soupes traditionnelles tha√Ø', en: 'Traditional Thai soups', th: '‡∏ã‡∏∏‡∏õ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°', ru: '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–π—Å–∫–∏–µ —Å—É–ø—ã', de: 'Traditionelle Thai-Suppen' },
    icon: 'üçú',
    order: 2,
    isActive: true,
    dishCount: 6
  },
  {
    _id: '3',
    name: { fr: 'Plats principaux', en: 'Main dishes', th: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å', ru: '–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞', de: 'Hauptgerichte' },
    description: { fr: 'Nos sp√©cialit√©s principales', en: 'Our main specialties', th: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤', ru: '–ù–∞—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–ª–∏–∫–∞—Ç–µ—Å—ã', de: 'Unsere Hauptspezialit√§ten' },
    icon: 'üçõ',
    order: 3,
    isActive: true,
    dishCount: 15
  },
  {
    _id: '4',
    name: { fr: 'Desserts', en: 'Desserts', th: '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô', ru: '–î–µ—Å–µ—Ä—Ç—ã', de: 'Nachspeisen' },
    description: { fr: 'Desserts traditionnels tha√Ø', en: 'Traditional Thai desserts', th: '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°', ru: '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–π—Å–∫–∏–µ –¥–µ—Å–µ—Ä—Ç—ã', de: 'Traditionelle Thai-Desserts' },
    icon: 'üç®',
    order: 4,
    isActive: true,
    dishCount: 5
  }
];

// Helper functions
function loadData(file, initialData) {
  try {
    const data = fs.readFileSync(file, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    fs.writeFileSync(file, JSON.stringify(initialData, null, 2));
    return initialData;
  }
}

function saveData(file, data) {
  fs.writeFileSync(file, JSON.stringify(data, null, 2));
}

// Routes
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// Dishes routes
app.get('/api/dishes', (req, res) => {
  const dishes = loadData(dishesFile, initialDishes);
  res.json(dishes);
});

app.get('/api/dishes/:id', (req, res) => {
  const dishes = loadData(dishesFile, initialDishes);
  const dish = dishes.find(d => d._id === req.params.id);
  
  if (!dish) {
    return res.status(404).json({ error: 'Dish not found' });
  }
  
  res.json(dish);
});

app.post('/api/dishes', (req, res) => {
  const dishes = loadData(dishesFile, initialDishes);
  const newDish = {
    _id: Date.now().toString(),
    ...req.body,
    createdAt: new Date(),
    updatedAt: new Date()
  };
  
  dishes.push(newDish);
  saveData(dishesFile, dishes);
  
  res.status(201).json(newDish);
});

app.put('/api/dishes/:id', (req, res) => {
  const dishes = loadData(dishesFile, initialDishes);
  const index = dishes.findIndex(d => d._id === req.params.id);
  
  if (index === -1) {
    return res.status(404).json({ error: 'Dish not found' });
  }
  
  dishes[index] = {
    ...dishes[index],
    ...req.body,
    updatedAt: new Date()
  };
  
  saveData(dishesFile, dishes);
  res.json(dishes[index]);
});

app.delete('/api/dishes/:id', (req, res) => {
  const dishes = loadData(dishesFile, initialDishes);
  const filteredDishes = dishes.filter(d => d._id !== req.params.id);
  
  saveData(dishesFile, filteredDishes);
  res.json({ message: 'Dish deleted successfully' });
});

// Categories routes
app.get('/api/categories', (req, res) => {
  const categories = loadData(categoriesFile, initialCategories);
  res.json(categories);
});

app.get('/api/categories/:id', (req, res) => {
  const categories = loadData(categoriesFile, initialCategories);
  const category = categories.find(c => c._id === req.params.id);
  
  if (!category) {
    return res.status(404).json({ error: 'Category not found' });
  }
  
  res.json(category);
});

app.post('/api/categories', (req, res) => {
  const categories = loadData(categoriesFile, initialCategories);
  const newCategory = {
    _id: Date.now().toString(),
    ...req.body,
    createdAt: new Date(),
    updatedAt: new Date()
  };
  
  categories.push(newCategory);
  saveData(categoriesFile, categories);
  
  res.status(201).json(newCategory);
});

app.put('/api/categories/:id', (req, res) => {
  const categories = loadData(categoriesFile, initialCategories);
  const index = categories.findIndex(c => c._id === req.params.id);
  
  if (index === -1) {
    return res.status(404).json({ error: 'Category not found' });
  }
  
  categories[index] = {
    ...categories[index],
    ...req.body,
    updatedAt: new Date()
  };
  
  saveData(categoriesFile, categories);
  res.json(categories[index]);
});

app.delete('/api/categories/:id', (req, res) => {
  const categories = loadData(categoriesFile, initialCategories);
  const filteredCategories = categories.filter(c => c._id !== req.params.id);
  
  saveData(categoriesFile, filteredCategories);
  res.json({ message: 'Category deleted successfully' });
});

// Analytics routes
app.get('/api/analytics', (req, res) => {
  const dishes = loadData(dishesFile, initialDishes);
  const categories = loadData(categoriesFile, initialCategories);
  
  // Simuler des vues pour les plats existants
  const dishesWithViews = dishes.map((dish, index) => {
    // Attribuer des vues simul√©es bas√©es sur l'index et popularity
    let views = Math.floor(Math.random() * 500) + 100; // Entre 100 et 600
    
    if (dish.tags?.isPopular) views += Math.floor(Math.random() * 300) + 200; // Bonus pour populaires
    if (dish.tags?.isChefSpecial) views += Math.floor(Math.random() * 200) + 100; // Bonus pour sp√©cialit√©s
    
    return { ...dish, views };
  });
  
  // Trier par vues d√©croissantes et prendre le top 5
  const topDishes = dishesWithViews
    .sort((a, b) => b.views - a.views)
    .slice(0, 5)
    .map((dish, index) => ({
      name: dish.name,
      views: dish.views,
      trend: Math.floor(Math.random() * 30) + 5, // Entre 5% et 35% d'augmentation
      languages: [
        { code: 'fr', percentage: 35 + Math.floor(Math.random() * 20) },
        { code: 'en', percentage: 25 + Math.floor(Math.random() * 20) },
        { code: 'th', percentage: 15 + Math.floor(Math.random() * 15) },
        { code: 'ru', percentage: 10 + Math.floor(Math.random() * 10) },
        { code: 'de', percentage: 5 + Math.floor(Math.random() * 10) }
      ]
    }));
  
  // Calculer les stats globales
  const totalViews = dishesWithViews.reduce((sum, dish) => sum + dish.views, 0);
  const totalDishes = dishes.length;
  const activeDishes = dishes.filter(dish => dish.isActive).length;
  
  const analytics = {
    overview: {
      totalViews: totalViews,
      uniqueVisitors: Math.floor(totalViews * 0.75), // ~75% de visiteurs uniques
      avgSessionTime: 3.8 + Math.random() * 1.4, // Entre 3.8 et 5.2 minutes
      conversionRate: 12.5 + Math.random() * 8, // Entre 12.5% et 20.5%
      trends: {
        views: Math.floor(Math.random() * 20) + 5, // +5% √† +25%
        visitors: Math.floor(Math.random() * 15) + 3, // +3% √† +18%
        sessionTime: Math.floor(Math.random() * 10) - 5 // -5% √† +5%
      }
    },
    topDishes: topDishes,
    languageStats: [
      { language: 'English', code: 'en', flag: 'üá¨üáß', percentage: 45, views: Math.floor(totalViews * 0.45), trend: 10 },
      { language: 'Fran√ßais', code: 'fr', flag: 'üá´üá∑', percentage: 25, views: Math.floor(totalViews * 0.25), trend: 5 },
      { language: '‡πÑ‡∏ó‡∏¢', code: 'th', flag: 'üáπüá≠', percentage: 15, views: Math.floor(totalViews * 0.15), trend: 15 },
      { language: '–†—É—Å—Å–∫–∏–π', code: 'ru', flag: 'üá∑üá∫', percentage: 10, views: Math.floor(totalViews * 0.10), trend: 8 },
      { language: 'Deutsch', code: 'de', flag: 'üá©üá™', percentage: 5, views: Math.floor(totalViews * 0.05), trend: 3 }
    ],
    timeAnalytics: {
      hourly: Array.from({ length: 18 }, (_, i) => {
        const hour = i + 6; // 6h √† 23h
        const baseViews = hour >= 11 && hour <= 14 ? 300 : hour >= 18 && hour <= 21 ? 400 : 150;
        return {
          hour,
          views: baseViews + Math.floor(Math.random() * 200)
        };
      }),
      daily: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].map(day => ({
        day,
        views: 1500 + Math.floor(Math.random() * 1000)
      })),
      weekly: ['S1', 'S2', 'S3', 'S4'].map(week => ({
        week,
        views: 8000 + Math.floor(Math.random() * 3000)
      }))
    },
    searchTerms: [
      { term: 'tacos', count: 567, trend: 28 },
      { term: 'burger', count: 423, trend: 15 },
      { term: 'pizza', count: 234, trend: 12 },
      { term: 'salade', count: 189, trend: 8 }
    ],
    deviceStats: {
      mobile: 85,
      tablet: 10,
      desktop: 5
    },
    metadata: {
      totalDishes,
      activeDishes,
      categories: categories.length,
      lastUpdated: new Date().toISOString()
    }
  };
  
  res.json(analytics);
});

// Root route
app.get('/', (req, res) => {
  res.json({
    message: 'Papy Restaurant API - Simple Version',
    version: '1.0.0',
    endpoints: {
      health: '/health',
      dishes: '/api/dishes',
      categories: '/api/categories'
    }
  });
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
  console.log(`üöÄ Simple API Server running on http://localhost:${PORT}`);
  console.log(`üîó Also available on http://127.0.0.1:${PORT}`);
  console.log(`üìä Health: http://localhost:${PORT}/health`);
  console.log(`üçΩÔ∏è Dishes: http://localhost:${PORT}/api/dishes`);
  console.log(`üè∑Ô∏è Categories: http://localhost:${PORT}/api/categories`);
});